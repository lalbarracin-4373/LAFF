<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reservas de Equipamiento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.19/index.global.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.19/index.global.min.js"></script>

  <style>
    :root { --primary:#0f5175; --primary-light:#72d0db; --bg:#f5f5f5; --card-bg:#fff; --border:#ddd; --danger:#c0392b; }
    * { box-sizing:border-box; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    body { margin:0; background:var(--bg); }
    header { background:var(--primary); color:#fff; padding:.8rem 1.5rem; display:flex; justify-content:space-between; }
    main { padding:1rem; max-width:1200px; margin:auto; }
    .layout { display:grid; grid-template-columns:300px 1fr; gap:1rem; }
    @media(max-width:800px){ .layout{ grid-template-columns:1fr; } }
    .card { background:#fff; border:1px solid var(--border); border-radius:8px; padding:1rem; }
    .toolbar { display:flex; gap:1rem; flex-wrap:wrap; }
    select,input,button { padding:.45rem; border:1px solid var(--border); border-radius:4px; }
    button.btn-primary { background:var(--primary); color:#fff; }
    button.btn-danger { background:var(--danger); color:#fff; }
  
    @media (max-width: 600px) {
      .fc .fc-toolbar-title {
        font-size: 1rem;
      }
      .fc .fc-col-header-cell-cushion,
      .fc .fc-timegrid-slot-label {
        font-size: 0.75rem;
      }
    }

  </style>
</head>
<body>
<header>
  <h1>Sistema de Reservas</h1>
  <span id="userEmailLabel">No has iniciado sesión</span>
</header>

<main>
<div class="layout">

<section class="card">
  <h2>Acceso</h2>
  <div id="authSection">
    <label>Email</label>
    <input id="email" type="email" />
    <label>Contraseña</label>
    <input id="password" type="password" />
    <button id="loginBtn" class="btn-primary">Iniciar sesión</button>
    <button id="forgotPasswordBtn">Olvidé mi contraseña</button>
    <div id="authStatus"></div>
  </div>

  <div id="logoutSection" style="display:none;">
    <p>Sesión iniciada como: <span id="loggedUserEmail"></span></p>
    <button id="changePasswordBtn">Cambiar contraseña</button>
    <button id="logoutBtn" class="btn-danger">Cerrar sesión</button>
    <div id="passwordStatus"></div>
  </div>
</section>

<section class="card">
  <h2>Calendario</h2>
  <div class="toolbar">
    <div>
      <label>Sala</label>
      <select id="labSelect"></select>
    </div>
    <div>
      <label>Equipo</label>
      <select id="equipmentSelect"></select>
    </div>
  </div>
  <div id="calendar"></div>
</section>

<section class="card" id="myReservationsSection" style="display:none;">
  <h2>Mis reservas</h2>
  <ul id="myReservationsList"></ul>
</section>

<section class="card" id="adminSection" style="display:none;">
  <h2>Administrador</h2>
  <ul id="adminReservationsList"></ul>
</section>

</div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword, onAuthStateChanged,
  signOut, sendPasswordResetEmail, updatePassword
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

import {
  getFirestore, collection, addDoc, query, where, onSnapshot,
  Timestamp, serverTimestamp, doc, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyA98AI1BeF-f6WWiQHe_bKoBe0KlaFwfcE",
  authDomain:"laboratory-schedules.firebaseapp.com",
  projectId:"laboratory-schedules"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAILS = ["leo@example.com"];

const LABS = [
  { id:"lab403_cultivo", name:"LAB403 – Cultivo", equipments:[
    {id:"c1",name:"Flujo grande"},{id:"c2",name:"Flujo virus"} ]},
  { id:"lab403_bacteria", name:"LAB403 – Bacteria", equipments:[
    {id:"b1",name:"Flujo grande"},{id:"b2",name:"Flujo virus"} ]},
  { id:"lab403_qpcr", name:"LAB403 – qPCR", equipments:[
    {id:"q1",name:"qPCR ROGER"},{id:"q2",name:"qPCR FREDDIE"},
    {id:"q3",name:"qPCR JOHN"},{id:"q4",name:"qPCR BRIAN"} ]},
  { id:"lab403_pcr", name:"LAB403 – PCR", equipments:[
    {id:"p1",name:"PCR Lennon"},{id:"p2",name:"PCR McCartney"},
    {id:"p3",name:"PCR Harrison"},{id:"p4",name:"PCR Starr"} ]},
  { id:"lab403_general", name:"LAB403 – General", equipments:[
    {id:"g1",name:"Western Blot"},{id:"g2",name:"Microscopio Fluorescencia"} ]},
  { id:"lab_a103", name:"LAB A103", equipments:[
    {id:"a1",name:"Flujo"},{id:"a2",name:"Cabina anaerobiosis"} ]}
];

const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const changePasswordBtn=document.getElementById("changePasswordBtn");
const forgotPasswordBtn=document.getElementById("forgotPasswordBtn");
const emailInput=document.getElementById("email");
const passwordInput=document.getElementById("password");
const authStatus=document.getElementById("authStatus");
const authSection=document.getElementById("authSection");
const logoutSection=document.getElementById("logoutSection");
const userEmailLabel=document.getElementById("userEmailLabel");
const loggedUserEmail=document.getElementById("loggedUserEmail");
const passwordStatus=document.getElementById("passwordStatus");

const labSelect=document.getElementById("labSelect");
const equipmentSelect=document.getElementById("equipmentSelect");

const myReservationsSection=document.getElementById("myReservationsSection");
const myReservationsList=document.getElementById("myReservationsList");

const adminSection=document.getElementById("adminSection");
const adminReservationsList=document.getElementById("adminReservationsList");

LABS.forEach(l=>{
  const opt=document.createElement("option");
  opt.value=l.id; opt.textContent=l.name;
  labSelect.appendChild(opt);
});

function loadEquip(labId){
  equipmentSelect.innerHTML="";
  const lab=LABS.find(x=>x.id===labId);
  lab.equipments.forEach(eq=>{
    const opt=document.createElement("option");
    opt.value=eq.id; opt.textContent=eq.name;
    equipmentSelect.appendChild(opt);
  });
}
loadEquip(LABS[0].id);

labSelect.onchange=()=>loadEquip(labSelect.value);

let currentUser=null;

onAuthStateChanged(auth,user=>{
  currentUser=user;
  if(user){
    authSection.style.display="none";
    logoutSection.style.display="block";
    userEmailLabel.textContent=user.email;
    loggedUserEmail.textContent=user.email;
  } else {
    authSection.style.display="block";
    logoutSection.style.display="none";
  }
});

loginBtn.onclick=async()=>{
  try{
    await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
  }catch(e){ authStatus.textContent=e.message; }
};

logoutBtn.onclick=()=>signOut(auth);

forgotPasswordBtn.onclick=async()=>{
  await sendPasswordResetEmail(auth,emailInput.value);
  authStatus.textContent="Email enviado (si existe)";
};

changePasswordBtn.onclick=async()=>{
  const np=prompt("Nueva contraseña:");
  if(!np) return;
  await updatePassword(currentUser,np);
  passwordStatus.textContent="Contraseña actualizada";
};

function isPast(date){ return date < new Date(); }

function overlaps(start,end,events){
  return events.some(ev=> start < ev.end && end > ev.start );
}

const calendar=new FullCalendar.Calendar(document.getElementById("calendar"),{
  initialView:"timeGridWeek",
  locale:"es",
  slotDuration:"00:15:00",
  snapDuration:"00:15:00",
  slotLabelFormat:{ hour:"2-digit", minute:"2-digit", hour12:false },
  eventTimeFormat:{ hour:"2-digit", minute:"2-digit", hour12:false },
  selectable:true,
  selectAllow:()=>!!currentUser,
  select:async(info)=>{
    if(isPast(info.start)){ alert("No se puede reservar en el pasado"); return;}
    if(overlaps(info.start,info.end,calendar.getEvents())){
      alert("Reserva superpuesta"); return;
    }
    const lab=LABS.find(l=>l.id===labSelect.value);
    const eq=lab.equipments.find(e=>e.id===equipmentSelect.value);
    if(!confirm(`Confirmar reserva en ${lab.name} – ${eq.name}?`)) return;
    await addDoc(collection(db,"reservations"),{
      labId:lab.id, labName:lab.name,
      equipmentId:eq.id, equipmentName:eq.name,
      start:Timestamp.fromDate(info.start),
      end:Timestamp.fromDate(info.end),
      userId:currentUser.uid, userEmail:currentUser.email,
      createdAt:serverTimestamp()
    });
  }
});
calendar.render();

queryReservations();
function queryReservations(){
  onSnapshot(collection(db,"reservations"),snap=>{
    calendar.removeAllEvents();
    const items=[];
    snap.forEach(d=>{
      const x=d.data();
      const s=x.start.toDate(), e=x.end.toDate();
      calendar.addEvent({
        title:`${x.labName} – ${x.equipmentName} (${x.userEmail})`,
        start:s, end:e
      });
    });
  });
}
</script>

</body>
</html>
